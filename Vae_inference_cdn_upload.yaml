name: CDN Download Files
description: Downloads handler.py, trained_model.pth, and config.properties files from CDN URLs and saves them locally with proper directory structure.
inputs:
  - {name: handler_url, type: String, description: "URL to fetch the handler.py file from"}
  - {name: pth_url, type: String, description: "URL to fetch the trained_model.pth model file from"}
  - {name: config_url, type: String, description: "URL to fetch the config.properties file from"}
outputs:
  - {name: handler_file, type: String, description: "Downloaded handler.py file"}
  - {name: pth_file, type: Model, description: "Downloaded trained_model.pth model file"}
  - {name: config_file, type: String, description: "Downloaded config.properties file"}
implementation:
  container:
    image: nikhilv215/nesy-factory:v22
    command:
      - sh
      - -c
      - |
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests || \
        PIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet requests --user
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import os
        import requests
        
        parser = argparse.ArgumentParser()
        parser.add_argument('--handler_url', type=str, required=True)
        parser.add_argument('--handler_file', type=str, required=True)
        parser.add_argument('--pth_url', type=str, required=True)
        parser.add_argument('--pth_file', type=str, required=True)
        parser.add_argument('--config_url', type=str, required=True)
        parser.add_argument('--config_file', type=str, required=True)
        
        args = parser.parse_args()
        
        # Fix URL escaping issue - convert $$ back to $
        def fix_url(url):
            return url.replace('$$', '$')
        
        handler_url = fix_url(args.handler_url)
        pth_url = fix_url(args.pth_url)
        config_url = fix_url(args.config_url)
        
        print("Original handler_url:", args.handler_url)
        print("Fixed handler_url:", handler_url)
        print("Original pth_url:", args.pth_url)
        print("Fixed pth_url:", pth_url)
        print("Original config_url:", args.config_url)
        print("Fixed config_url:", config_url)
        
        try:
            # Download handler.py
            print("Fetching handler.py from CDN:", handler_url)
            resp_handler = requests.get(handler_url, timeout=120)
            resp_handler.raise_for_status()
            
            os.makedirs(args.handler_file, exist_ok=True)
            handler_path = os.path.join(args.handler_file, 'handler.py')
            with open(handler_path, "w") as f:
                f.write(resp_handler.text)
            print("Handler file saved at:", handler_path)
            print("Handler size:", len(resp_handler.text), "characters")
            
            # Download trained_model.pth model file
            print("Fetching trained_model.pth from CDN:", pth_url)
            resp_pth = requests.get(pth_url, timeout=300)
            resp_pth.raise_for_status()
            
            os.makedirs(args.pth_file, exist_ok=True)
            pth_path = os.path.join(args.pth_file, 'trained_model.pth')
            with open(pth_path, "wb") as f:
                f.write(resp_pth.content)
            print("PTH model file saved at:", pth_path)
            print("PTH model size:", len(resp_pth.content), "bytes")
            
            # Download config.properties
            print("Fetching config.properties from CDN:", config_url)
            resp_config = requests.get(config_url, timeout=120)
            resp_config.raise_for_status()
            
            os.makedirs(args.config_file, exist_ok=True)
            config_path = os.path.join(args.config_file, 'config.properties')
            with open(config_path, "w") as f:
                f.write(resp_config.text)
            print("Config file saved at:", config_path)
            print("Config size:", len(resp_config.text), "characters")
            
            print("All files downloaded successfully!")
            print("Output structure:")
            print("  - handler_file/handler.py")
            print("  - pth_file/trained_model.pth")
            print("  - config_file/config.properties")
            
            # Verify files exist and have content
            if os.path.exists(handler_path) and os.path.getsize(handler_path) > 0:
                print("handler.py downloaded and verified")
            else:
                raise Exception("handler.py download verification failed")
                
            if os.path.exists(pth_path) and os.path.getsize(pth_path) > 0:
                print("trained_model.pth downloaded and verified")
            else:
                raise Exception("trained_model.pth download verification failed")
                
            if os.path.exists(config_path) and os.path.getsize(config_path) > 0:
                print("config.properties downloaded and verified")
            else:
                raise Exception("config.properties download verification failed")
                
        except requests.exceptions.Timeout:
            print("Error: Request timed out while downloading from CDN")
            exit(1)
        except requests.exceptions.RequestException as e:
            print("Error: Network error during download:", str(e))
            exit(1)
        except Exception as e:
            print("Error: Failed to download files:", str(e))
            import traceback
            traceback.print_exc()
            exit(1)

    args:
      - --handler_url
      - {inputValue: handler_url}
      - --handler_file
      - {outputPath: handler_file}
      - --pth_url
      - {inputValue: pth_url}
      - --pth_file
      - {outputPath: pth_file}
      - --config_url
      - {inputValue: config_url}
      - --config_file
      - {outputPath: config_file}
